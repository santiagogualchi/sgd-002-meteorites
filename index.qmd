---
title: Meteorite Landings
author: Santiago Gualchi
format:
  html:
    df-print: kable
    fig-width: 6
    fig-height: 6
execute: 
  warning: false
---

## Introduction

## Packages

```{r}
library(dplyr)
library(forcats)
library(ggplot2)
library(ggtext)
library(glue)
library(readr)
library(stringr)
library(tibble)
library(tidyr)
```

## Palette

Here I define the colors that will be used throughout the slides:

```{r}
color_bg <- "#ffffff"
color_grey_1 <- "#e3e3e3"
color_grey_2 <- "#a1a1a1"
color_grey_3 <- "#6d6d6d"
color_grey_4 <- "#444444"
color_accent_light <- "#62beff"
color_accent_dark <- "#0077cc"
```

## Themes

Here I define the themes for the ggplots.

### Cover theme

```{r}
theme_cover <- theme_void() +
  theme(
    plot.background = element_rect(
      fill = color_accent_light,
      color = "transparent"
    )
  )
```

### Default theme

```{r}
theme_default <- theme_minimal() +
  theme(
    text = element_text(
      color = color_grey_3,
      size = unit(14, "pt")
    ),
    axis.text.x = element_text(
      size = unit(10, "pt"),
      color = color_grey_3
    ),
    panel.grid = element_blank(),
    plot.background = element_rect(
      fill = color_bg,
      color = "transparent"
    ),
    plot.title = element_text(
      face = "bold",
      color = color_grey_4,
      size = unit(18, "pt")
    ),
    plot.title.position = "plot",
    plot.caption = element_text(color = color_grey_2, size = 10),
    plot.margin = margin(.04, .04, .04, .04, "npc")
  )
```

### Add X line to theme

```{r}
theme_x_line <- 
  theme(
    axis.ticks.x = element_line(
      color = color_grey_1
    ),
    axis.line.x = element_line(
      color = color_grey_1
    )
  )
```

## Data

We'll use the web-scraped data if available, or the alternative data otherwise:

```{r}
file_path <- if (file.exists("nogit/tidy-data.csv")) {
  "nogit/tidy-data.csv"
} else {
  "data/meteorite-landings/meteorite-landings.csv"
}

data_raw <- read_csv(
  file_path,
  na = "",
  col_types = cols_only(
    name = col_character(),
    nametype = col_factor(),
    # recclass = col_factor(),
    mass = col_double(),
    fall = col_factor(),
    year = col_integer(),
    reclat = col_double(),
    reclong = col_double(),
    place = col_character()
  )
) |> 
  # This mutates are performed to transform the alternative data into a format
  # compatible with the web-scraped data:
  mutate(
    nametype = fct_recode(nametype, Official = "Valid"),
    fall = fct_recode(fall, Fall = "Fell", Find = "Found")
  ) |> 
  # This left_join is performed in order to ensure that there's a place column
  # in the alternative data.
  left_join(
    tibble(name = "INEXISTENT-NAME-SANTIGUALCHI.DATA", place = ""),
    by = "name",
    # We include the suffixes because, for the web-scraped data, there'll be
    # two place columns. This way, we preserve the original place column name
    # and distinguish the dummy column with the suffix "_drop".
    suffix = c("", "_drop")
  ) |> 
  # Now we can drop the dummy column if present.
  select(-ends_with("_drop"))

head(data_raw, 10)
```

Now we'll do some tidying:

```{r}
data_tidy <- data_raw |> 
  # Rename to have more descriptive names.
  rename(
    # class = recclass,
    latitude = reclat,
    longitude = reclong
  ) |> 
  # Remove data-points of on-going year.
  filter(year < max(year, na.rm = TRUE)) |> 
  # Keep only meteorites (other nametypes are not meteorites).
  filter(nametype %in% c("Official", "Provisional")) |> 
  mutate(
    # Remove meaningless trailing characters from names.
    name = str_replace(name, r"{\s*\*\*$}", ""),
    # Remove meteorites on null island.
    latitude = if_else(latitude == 0 & longitude == 0, NA_real_, latitude),
    longitude = if_else(latitude == 0 & longitude == 0, NA_real_, longitude)
  )

head(data_tidy, 10)
```

Get counts by year:

```{r}
data_counts_by_year <- data_tidy |> 
  group_by(year) |> 
  summarize(n = n())

head(data_counts_by_year, 10)
```


## Cover

This will be the cover of the instagram post. I'll use `{ggplot2}` to create it,
to have a consistent format across all slides:

```{r}
ggplot(tibble(0)) +
  geom_textbox(
    label = "Meteorites:<br>Landings<br>And Discoveries",
    x = 0,
    y = 0,
    width = unit(5, "inch"),
    size = 14,
    fontface = "bold",
    color = NA,
    text.color = color_bg,
    fill = NA,
    lineheight = 1.3,
    halign = 1,
    hjust = .5,
    vjust = .5
  ) + 
  scale_x_continuous(limits = c(-9, 9)) +
  scale_y_continuous(limits = c(-9, 9)) +
  theme_cover
```


## Discoveries per year

This plot will have the number of meteorites found by year:

```{r}
data_counts_by_year_since_1800 <- data_counts_by_year |> 
  filter(year >= 1800)

milestones <- tribble(
  ~year, ~milestone,
  1803,  "Recognition of meteorites<br>as extraterrestrial",
  1957,  "Beginning of<br>the Space Age",
  2023,  "Present day"
)

ggplot(
  data_counts_by_year_since_1800,
  mapping = aes(
    x = year,
    y = n
  )
) +
  geom_vline(
    data = milestones,
    mapping = aes(
      xintercept = year
    ),
    linetype = "longdash",
    color = color_grey_1
  ) +
  geom_richtext(
    data = milestones,
    mapping = aes(
      x = year + 3,
      label = paste0(
        "<span style='font-size:12pt;'>**", year, "**</span><br>",
        "<span style='font-size:11pt;'>", milestone, "</span><br>"
      )
    ),
    y = max(data_counts_by_year_since_1800$n) + 1800,
    color = color_grey_3,
    fill = "transparent",
    label.color = "transparent",
    hjust = 0,
    vjust = 1,
    label.padding = unit(0, "pt")
  ) +
  geom_col(
    fill = color_accent_light,
    # This overlaps, but I want the bars to be more visible.
    width = 2
  ) +
  scale_x_continuous(
    limits = c(1800, 2050),
    breaks = seq(1800, 2050, by = 50),
    expand = expansion(mult = c(.05, .075))
  ) +
  scale_y_continuous(
    breaks = NULL,
    expand = expansion(mult = 0, add = c(0, 2000))
  ) +
  labs(
    title = "Most Meteorites Were Found Very Recently",
    subtitle = "Almost all discoveries happened after the Space Age began",
    x = NULL,
    y = NULL,
    caption = "Source: The Meteoritical Bulletin Database"
  ) +
  theme_default +
  theme_x_line
```

## Discoveries Last 10 Years

```{r}
data_counts_by_year_last_10_years <- data_counts_by_year |>
  filter(year > (max(year) - 10))

# This function formats x. It truncates x to only keep the number signif of
# significative digits (even for whole numbers). For example,
# pretty_number(12345) returns 12000. Further arguments are passed to prettyNum.
pretty_number <- function(x, signif = 2, ...) {
  (x - x %% 10 ^ (floor(log10(x)) - (signif - 1))) |> 
    prettyNum(...)
}

ggplot(
  data_counts_by_year_last_10_years,
  mapping = aes(
    x = year,
    y = n
  )
) +
  geom_col(
    fill = color_accent_light,
    width = .7
  ) +
  geom_text(
    aes(
      label = n
    ),
    size = 4,
    fontface = "bold",
    color = color_bg,
    nudge_y = -60
  ) +
  scale_x_continuous(
    breaks = data_counts_by_year_last_10_years$year,
    expand = expansion(mult = 0)
  ) +
  scale_y_continuous(
    breaks = NULL,
    expand = expansion(mult = 0)
  ) +
  labs(
    title = glue(
      "Over ",
      pretty_number(sum(data_counts_by_year_last_10_years$n), big.mark = ","),
      " Meteorites Found In 10 Years", 
    ),
    subtitle = glue(
      "And many others are still in the process of being recognized"
    ),
    x = NULL,
    y = NULL,
    caption = "Source: The Meteoritical Bulletin Database"
  ) +
  theme_default
```

## Impact positions

```{r}
data_positions <- data_tidy |> 
  filter(longitude >= -180 & longitude <= 180) |> 
  replace_na(
    list(
      mass = median(data_tidy$mass, na.rm = TRUE)
    )
  ) |> 
  arrange(desc(mass))
```

```{r}
get_meteorite_label <- function(name, year, mass, place) {
  glue(
    "<span style='font-size:12pt;'>**{name}** ({year})</span><br>",
    "<span style='font-size:11pt;'>", place, "<br>",
    "{prettyNum(mass / 1e3, big.mark = ',')} kg</span>"
  )
}

get_meteorite_textbox <- function(data, nrow, x, y) {
  geom_textbox(
    data = data[nrow, ],
    mapping = aes(
      label = get_meteorite_label(name, year, mass, place)
    ),
    x = x,
    y = y,
    box.r = unit(0, "pt"),
    fill = color_bg,
    box.color = color_accent_dark,
    box.size = .5,
    color = color_grey_4
  )
}

world <- map_data("world")

ggplot(data_positions) +
  geom_map(
    data = world,
    map = world,
    mapping = aes(
      long,
      lat,
      map_id = region
    ),
    color = color_grey_1,
    fill = color_grey_1
  ) +
  geom_point(
    aes(
      x = longitude,
      y = latitude,
      size = mass
    ),
    color = color_grey_2,
    shape = 1,
    alpha = 1/2
  ) +
  geom_segment(
    data = data_positions[1:4, ],
    mapping = aes(
      x = longitude,
      y = latitude,
      xend = longitude
    ),
    yend = c(135, -135, 135, -135),
    color = color_accent_dark
  ) +
  geom_segment(
    data = data_positions[1:4, ],
    mapping = aes(
      x = longitude
    ),
    y = c(135, -135, 135, -135),
    xend = c(110, 110, -110, -110),
    yend = c(135, -135, 135, -135),
    color = color_accent_dark
  ) +
  get_meteorite_textbox(
    data_positions,
    nrow = 1,
    x = 110,
    y = 135
  ) +
  get_meteorite_textbox(
    data_positions,
    nrow = 2,
    x = 110,
    y = -135
  ) +
  get_meteorite_textbox(
    data_positions,
    nrow = 3,
    x = -110,
    y = 135
  ) +
  get_meteorite_textbox(
    data_positions,
    nrow = 4,
    x = -110,
    y = -135
  ) +
  geom_point(
    data = data_positions[1:4, ],
    aes(
      x = longitude,
      y = latitude,
      size = mass
    ),
    color = color_accent_dark,
    fill = color_accent_light,
    shape = 21,
    stroke = .65
  ) +
  guides(
    size = "none"
  ) +
  scale_x_continuous(
    breaks = NULL,
    expand = expansion(mult = 0),
    limits = c(-180, 180)
  ) +
  scale_y_continuous(
    breaks = NULL,
    expand = expansion(mult = 0),
    # latitude is bound -90 to 90, but we're including extra space for the
    # textboxes.
    limits = c(-180, 180)
  ) +
  labs(
    title = "A Global Phenomenon",
    subtitle =  "Meteorites have been striking Earth all over the globe",
    x = NULL,
    y = NULL,
    caption = "Source: The Meteoritical Bulletin Database"
  ) +
  theme_default
```
